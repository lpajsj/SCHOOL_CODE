#include "arm_math.h"
#include "stm32f10x.h"
#include "arm_const_structs.h"
#include "ange_usart.h"
float in[1024]={
0.076313,-0.251526,-0.424298,-0.595238,-0.762515,-0.920024,-1.075092,-1.217949,-1.355922,-1.481685,-1.597680,-1.700855,-1.793651,-1.871184,-1.934676,-1.983517,-2.017094,-2.036020,-2.040293,
	-2.027473,-2.003053,-1.960317,-1.905372,-1.832723,-1.749695,-1.651404,-1.543956,-1.422466,-1.291819,-1.151404,-1.000000,-0.843712,-0.678266,-0.510989,-0.340659,-0.165446,0.007937,0.184371,
	0.357753,0.529304,0.695360,0.856532,1.009768,1.157509,1.296703,1.423687,1.540904,1.646520,1.738706,1.797314,1.882784,1.935897,1.968865,1.990232,1.990232,1.991453,1.963980,1.924298,1.871184,
	1.807082,1.723443,1.628205,1.519536,1.402320,1.269841,1.128205,0.980464,0.824176,0.663004,0.495116,0.322344,0.148962,-0.026862,-0.199634,-0.373626,-0.546398,-0.712454,-0.876068,-1.031746,
	-1.178877,-1.315629,-1.448718,-1.565324,-1.672161,-1.768620,-1.847375,-1.914530,-1.969475,-2.007937,-2.032357,-2.042125,-2.032967,-2.012821,-1.973749,-1.921245,-1.856532,-1.774725,-1.680098,
	-1.575092,-1.459097,-1.329060,-1.192308,-1.045788,-0.889499,-0.728938,-0.562271,-0.390720,-0.217338,-0.042125,0.132479,0.306471,0.479243,0.646520,0.808303,0.976190,1.115995,1.254579,1.388278,
	1.509158,1.618437,1.715507,1.797314,1.866911,1.924298,1.963370,1.988401,2.002442,1.992064,1.977412,1.940781,1.890110,1.826618,1.747863,1.655678,1.551893,1.431013,1.308913,1.170940,1.026252,
	0.869353,0.710623,0.544567,0.373016,0.200244,0.025641,-0.149573,-0.324176,-0.495727,-0.665446,-0.828449,-0.985348,-1.134921,-1.277778,-1.411477,-1.531746,-1.642857,-1.740537,-1.827228,
	-1.897436,-1.955433,-1.999390,-2.025641,-2.038462,-2.036630,-2.022589,-1.989011,-1.938339,-1.878510,-1.801587,-1.710012,-1.606838,-1.495116,-1.367521,-1.232601,-1.088523,-0.934676,-0.777167,
	-0.610501,-0.440781,-0.269231,-0.092796,0.081807,0.256410,0.429182,0.600122,0.763126,0.918193,1.072039,1.216117,1.351648,1.471917,1.586691,1.681319,1.774725,1.846154,1.905372,1.952381,
	1.982906,1.997558,1.997558,1.982906,1.950549,1.904762,1.846154,1.772283,1.684371,1.582418,1.470086,1.345543,1.210012,1.068376,0.916972,0.757021,0.593407,0.424298,0.252137,0.078144,-0.098291,
	-0.274115,-0.445055,-0.616606,-0.782051,-0.939560,-1.093407,-1.238706,-1.371795,-1.497558,-1.612332,-1.668498,-1.804029,-1.877900,-1.938950,-1.988401,-2.022589,-2.032357,-2.038462,-2.025641,
	-1.996948,-1.950549,-1.895604,-1.822344,-1.736874,-1.637973,-1.528083,-1.432234,-1.274115,-1.132479,-0.981074,-0.823565,-0.659951,-0.489011,-0.318681,-0.144689,0.032357,0.205739,0.378510,
	0.548840,0.713675,0.875458,1.029304,1.181929,1.311355,1.439561,1.555556,1.656899,1.752747,1.826618,1.891941,1.942613,1.973138,1.992064,1.997558,1.987180,1.958486,1.919414,1.865690,1.793651,
	1.709402,1.611722,1.509158,1.382173,1.251526,1.109280,0.962149,0.804640,0.644078,0.473748,0.301587,0.128816,-0.046398,-0.222222,-0.396215,-0.563492,-0.733822,-0.894994,-1.048230,-1.195971,
	-1.333333,-1.467033,-1.578755,-1.684371,-1.782051,-1.856532,-1.924908,-1.973749,-2.009158,-2.032357,-2.039683,-2.028694,-2.004274,-1.963980,-1.913919,-1.846764,-1.764957,-1.670940,-1.563492,
	-1.443834,-1.313187,-1.173993,-1.024420,-0.869963,-0.707570,-0.541514,-0.368132,-0.195360,-0.020147,0.159951,0.328449,0.498779,0.667277,0.827839,0.986569,1.132479,1.273504,1.402930,1.521368,
	1.670330,1.722222,1.807082,1.877289,1.928571,1.963370,1.989622,1.997558,1.991453,1.968254,1.934066,1.880342,1.816850,1.738706,1.643468,1.536020,1.420024,1.291209,1.152625,1.006105,0.850427,
	0.689866,0.522589,0.345543,0.179487,0.004274,-0.171551,-0.344933,-0.517094,-0.684371,-0.848596,-1.004274,-1.153236,-1.265568,-1.426740,-1.545177,-1.652015,-1.750916,-1.834554,-1.906593,
	-1.957265,-2.003053,-2.028083,-2.038462,-2.031746,-2.014042,-1.983517,-1.931013,-1.866911,-1.788156,-1.691697,-1.594017,-1.478022,-1.353480,-1.215507,-1.068987,-0.915140,-0.755800,-0.589744,
	-0.418803,-0.247253,-0.070818,0.103785,0.278388,0.449939,0.619658,0.782051,0.941392,1.089133,1.233211,1.362637,1.488401,1.598901,1.697192,1.787546,1.855922,1.911477,1.953602,1.987180,1.997558,
	1.995116,1.978022,1.948107,1.898657,1.835165,1.757631,1.670330,1.567766,1.455434,1.333333,1.195971,1.050061,0.898046,0.737485,0.573871,0.402320,0.226496,0.055556,-0.119048,-0.294261,-0.467033,
	-0.635531,-0.799756,-0.958486,-1.110501,-1.254579,-1.388889,-1.507326,-1.623932,-1.724054,-1.812576,-1.887057,-1.945665,-1.989622,-2.014042,-2.034188,-2.032967,-2.022589,-1.990232,-1.947497,
	-1.885836,-1.813187,-1.725885,-1.623932,-1.514652,-1.389499,-1.255189,-1.112332,-0.961538,-0.801587,-0.639194,-0.468864,-0.297314,-0.123321,0.053724,0.228938,0.400488,0.569597,0.734432,
	0.894383,1.048840,1.191697,1.327228,1.455434,1.567155,1.670330,1.757631,1.833944,1.896215,1.944444,1.975580,1.994506,1.992064,1.982906,1.956654,1.912088,1.855922,1.782662,1.699634,1.599512,
	1.489622,1.366300,1.235653,1.094017,0.942002,0.783883,0.622100,0.453602,0.311355,0.106838,-0.067766,-0.242979,-0.421245,-0.586081,-0.751526,-0.913919,-1.068987,-1.211233,-1.349817,-1.476801,
	-1.592796,-1.693529,-1.780220,-1.857753,-1.921856,-1.966422,-1.992064,-2.009768,-2.023810,-2.012821,-1.992064,-1.954823,-1.905372,-1.832112,-1.750916,-1.656899,-1.543956,-1.426740,-1.296093,
	-1.155678,-0.995727,-0.851648,-0.688034,-0.519536,-0.318071,-0.173382,0.005495,0.176435,0.350427,0.521368,0.688645,0.848596,1.003663,1.152625,1.286935,1.416361,1.535409,1.638584,1.733822,
	1.814408,1.885226,1.934066,1.970696,1.990232,1.997558,1.988401,1.964591,1.926740,1.863248,1.807082,1.724054,1.631258,1.523199,1.405983,1.274725,1.135531,0.990843,0.832723,0.666667,0.503663,
	0.331502,0.161172,-0.016484,-0.192308,-0.368132,-0.537851,-0.705128,-0.867521,-1.023810,-1.170940,-1.316239,-1.441392,-1.559829,-1.672161,-1.758242,-1.833333,-1.901709,-1.956044,-1.992064,
	-2.009158,-2.028694,-2.022589,-2.001221,-1.962149,-1.916972,-1.852259,-1.777167,-1.682540,-1.580586,-1.462760,-1.334554,-1.196581,-1.051893,-0.896825,-0.734432,-0.567155,-0.398657,-0.224054,
	-0.048840,0.125153,0.300366,0.471306,0.641026,0.803419,0.959096,1.108059,1.250916,1.382173,1.500000,1.611722,1.709402,1.791209,1.863248,1.919414,1.958486,1.984127,1.998169,1.992064,1.973138,
	1.939560,1.890110,1.826618,1.748474,1.660562,1.555556,1.438340,1.313797,1.177045,1.031136,0.880952,0.717949,0.551893,0.380952,0.208791,0.034799,-0.141026,-0.315018,-0.487179,-0.655678,-0.819902,
	-0.976801,-1.126984,-1.270452,-1.402930,-1.525641,-1.636752,-1.735043,-1.810745,-1.877289,-1.937729,-1.973749,-1.999390,-2.032357,-2.023810,-1.999390,-1.974970,-1.929182,-1.876068,-1.801587,
	-1.713065,-1.612332,-1.497558,-1.373626,-1.238706,-1.093407,-0.942002,-0.782051,-0.617216,-0.447497,-0.269841,-0.100122,0.074481,0.249084,0.421856,0.590965,0.753968,0.913309,1.065934,
	1.208181,1.343101,1.467644,1.579365,1.681319,1.770452,1.841880,1.904762,1.948107,1.978022,2.000000,1.997558,1.982906,1.953602,1.906593,1.846154,1.773504,1.684982,1.587302,1.474970,1.349817,
	1.217949,1.074481,0.924298,0.765568,0.598901,0.431624,0.260073,0.084860,-0.089744,-0.264347,-0.437729,-0.607448,-0.772894,-0.931624,-1.084860,-1.231380,-1.365690,-1.490232,-1.604396,-1.710012,
	-1.793651,-1.867521,-1.923687,-1.962759,-2.000000,-2.021368,-2.023810,-2.014042,-1.989622,-1.947497,-1.895604,-1.827228,-1.741758,-1.642857,-1.534188,-1.410867,-1.282662,-1.137363,-0.988401,
	-0.830891,-0.666056,-0.498779,-0.328449,-0.150794,0.023810,0.197802,0.371184,0.541514,0.708181,0.869353,1.023199,1.167888,1.317460,1.435897,1.549451,1.655678,1.744200,1.826618,1.889499,
	1.938339,1.973138,1.995116,1.998169,1.987790,1.963370,1.920024,1.869353,1.796093,1.713065,1.616606,1.509158,1.387057,1.260073,1.118437,0.971917,0.812576,0.651404,0.481074,0.309524,0.136142,
	-0.036630,-0.213675,-0.387057,-0.557387,-0.724664,-0.886447,-1.041514,-1.188645,-1.326007,-1.456044,-1.574481,-1.678266,-1.773504,-1.852259,-1.918193,-1.971307,-2.009158,-2.032357,-2.048230,
	-2.027473,-2.004884,-1.970086,-1.914530,-1.849206,-1.771062,-1.675824,-1.567155,-1.448108,-1.319292,-1.178877,-1.031746,-0.877289,-0.717338,-0.548230,-0.378510,-0.203297,-0.027473,0.146520,
	0.319902,0.492063,0.659341,0.822344,0.976801,1.129426,1.267399,1.396825,1.516484,1.623932,1.719780,1.800977,1.871184,1.924298,1.963370,1.987790,1.997558,1.991453,1.968254,1.934066,1.885226,
	1.818071,1.738706,1.645910,1.543346,1.426129,1.296703,1.159951,1.013431,0.859585,0.687424,0.531746,0.365690,0.188034,0.011600,-0.163614,-0.336386,-0.507937,-0.677045,-0.840659,-0.995116,
	-1.147131,-1.287546,-1.420024,-1.540293,-1.651404,-1.749084,-1.829060,-1.901099,-1.978633,-2.003053,-2.023810,-2.038462,-2.034799,-2.016484,-1.983517,-1.934676,-1.871795,-1.793651,-1.697802,
	-1.598901,-1.482906,-1.358364,-1.221612,-1.076313,-0.924298,-0.764957,-0.597070,-0.429182,-0.254579,-0.081197,0.095849,0.269841,0.442002,0.610501,0.776557,0.932845,1.084249,1.225885,1.358974,
	1.481685,1.594017,1.694750,1.777778,1.851038,1.909646,1.953602,1.982906,1.997558,1.996337,1.978633,1.989622,1.901709,1.840049,1.764347,1.675214,1.575092,1.459707,1.335775,1.201465,1.056777,
	0.903541,0.744811,0.580586,0.410256,0.238706,0.062882,-0.111111,-0.286935,-0.457875,-0.628816,-0.794261,-0.954212,-1.098901,-1.199634,-1.382784,-1.505495,-1.618437,-1.721001,-1.810134,
	-1.883394,-1.944444,-1.988401,-2.022589,-2.034188,-2.039683,-2.022589,-1.992064,-1.949939,-1.891331,-1.817460,-1.731380,-1.631868,-1.521978,-1.397436,-1.261905,-1.120269,-0.968254,-0.812576,
	-0.645910,-0.477411,-0.305861,-0.130647,0.045177,0.220391,0.391941,0.564103,0.727717,0.888889,1.040293,1.185592,1.327228,1.445666,1.562882,1.660562,1.755189,1.831502,1.894994,1.943834,1.976801,
	1.992064,1.997558,1.986569,1.960928,1.913919,1.858364,1.787546,1.703907,1.606227,1.494506,1.373626,1.240537,1.098901,0.949939,0.791819,0.629426,0.460317,0.289377,0.114774,-0.060440,-0.235653,-0.409035,
	-0.579976,-0.744200,-0.907814,-1.060440,-1.206960,-1.344322,-1.470086,-1.583028,-1.691697};
#define fs 44800
#define pi 3.1415926
#define num 1024
float input[2*num];
float out[num];
arm_cfft_instance_f32 varInstCfftF32;
  float32_t maxValue;
	u32 testIndex;
 void InitBufInArray()
 {
     unsigned short i;
	 /*当采样频率为44800时频率4900,8400,18725幅值分别为1500 2700 4000的正弦信号的叠加，直流分量为100*/
    for(i=0; i<num*2; i+=2)
     {
         input[i] = in[i/2];
//         input[i] = 1500 * sin(pi * i * 4900.0 / fs) +\
//              2700 * sin(pi * i * 8400.0 / fs) +\
//              4000 * sin(pi * i * 18725.0 / fs)+100;
         input[i+1]=0;
    }
 }
int32_t main(void)
{
	u16 i;
	ange_USART_init(115200);
  arm_status status;
	/* cfft 函数结构体初始化，num对应取的点数，也可以不用初始化，直接有相应的定义
	arm_cfft_sR_f32_len256，arm_cfft_sR_f32_len512等*/
  arm_cfft_init_f32(&varInstCfftF32,num);
	/*模拟产生几个频率正弦波在fs采样率下的数据  
	当前复数 FFT 函数支持浮点类型， Q31 和 Q15类型。 有待分析的数据存放在一个输入数组中，
	为了节省空间，这些 FFT 函数将FFT的变换结果覆盖在输入数组中，数组的顺序均为：实部、虚部、
	实部、虚部，所以输入数组长度为取样点的2倍*/
	InitBufInArray();
	/*fft变换*/
  arm_cfft_f32(&varInstCfftF32, input, 0, 1);
	/*复数求模运算，根据out数组就可以分析频率幅值，除去第一个点得出的数据前一半与后一半数据是对称的，也就是说
	可以测的频率最大为采样频率的一半，
	若采样频率为 Fs，信号频率 F，采样点数为 N，那么某点 n 所表示的频率为：
Fn=(n-1)*Fs/N; （假设n从1开始计数）
		FFT得到的第一点频率为0，即为直流分量，其幅值为实际直流分量的N倍
	而X后面的为复数，其幅值为实际的N/2倍
若FFT变换后第n点的幅度值为An，则对应的实际物理幅度数值：
A=An/(N/2);
运用上述公式即可将FFT结果和实际物理量对应起来*/
  arm_cmplx_mag_f32(input,out,num);
/*找出数组最大值以及下标*/
  arm_max_f32(out, num, &maxValue, &testIndex);
	for(i=0;i<=512;i++)
	{
		if(i==0)
		{
		  printf("%lf,",out[i]/num);
		}
		else
		{
			printf("%lf,",out[i]/num*2);
		}
	}
//	printf("%lf,%d\n",maxValue,testIndex);
    while (1);                             /* main function does not return */
}