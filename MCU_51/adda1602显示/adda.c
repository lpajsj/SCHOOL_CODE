#include <reg51.h>
#include <absacc.h>
#include <intrins.h>
#include <stdio.h>
#include "ange.h"
#include "lcd1602.h"
#include "anjian.h"
uint code sin[]={0x1ff,0x20c,0x218,0x225,0x231,0x23e,0x24a,0x257,0x263,0x270,0x27c,0x288,
	0x294,0x2a0,0x2ac,0x2b8,0x2c3,0x2cf,0x2da,0x2e6,0x2f1,0x2fc,0x307,0x312,0x31c,0x327,0x331,
	0x33b,0x345,0x34e,0x358,0x361,0x36a,0x373,0x37b,0x383,0x38c,0x393,0x39b,0x3a2,0x3a9,0x3b0,
	0x3b7,0x3bd,0x3c3,0x3c9,0x3ce,0x3d4,0x3d8,0x3dd,0x3e1,0x3e5,0x3e9,0x3ed,0x3f0,0x3f3,0x3f5,
	0x3f7,0x3f9,0x3fb,0x3fc,0x3fd,0x3fe,0x3fe,0x3fe,0x3fe,0x3fe,0x3fd,0x3fc,0x3fa,0x3f8,0x3f6,
	0x3f4,0x3f1,0x3ee,0x3eb,0x3e7,0x3e3,0x3df,0x3db,0x3d6,0x3d1,0x3cc,0x3c6,0x3c0,0x3ba,0x3b4,
	0x3ad,0x3a6,0x39f,0x397,0x38f,0x388,0x37f,0x377,0x36e,0x365,0x35c,0x353,0x349,0x340,0x336,
	0x32c,0x321,0x317,0x30c,0x301,0x2f7,0x2eb,0x2e0,0x2d5,0x2c9,0x2be,0x2b2,0x2a6,0x29a,0x28e,
	0x282,0x276,0x269,0x25d,0x251,0x244,0x238,0x22b,0x21e,0x212,0x205,0x1f9,0x1ec,0x1e0,0x1d3,
	0x1c6,0x1ba,0x1ad,0x1a1,0x195,0x188,0x17c,0x170,0x164,0x158,0x14c,0x140,0x135,0x129,0x11e,
	0x113,0x107,0xfd,0xf2,0xe7,0xdd,0xd2,0xc8,0xbe,0xb5,0xab,0xa2,0x99,0x90,0x87,0x7f,0x76,0x6f,
	0x67,0x5f,0x58,0x51,0x4a,0x44,0x3e,0x38,0x32,0x2d,0x28,0x23,0x1f,0x1b,0x17,0x13,0x10,0xd,0xa
	,0x8,0x6,0x4,0x2,0x1,0x0,0x0,0x0,0x0,0x0,0x1,0x2,0x3,0x5,0x7,0x9,0xb,0xe,0x11,0x15,0x19,0x1d,
	0x21,0x26,0x2a,0x30,0x35,0x3b,0x41,0x47,0x4e,0x55,0x5c,0x63,0x6b,0x72,0x7b,0x83,0x8b,0x94,
	0x9d,0xa6,0xb0,0xb9,0xc3,0xcd,0xd7,0xe2,0xec,0xf7,0x102,0x10d,0x118,0x124,0x12f,0x13b,0x146,
	0x152,0x15e,0x16a,0x176,0x182,0x18e,0x19b,0x1a7,0x1b4,0x1c0,0x1cd,0x1d9,0x1e6,0x1f2,0x1ff};
uint code san[]={0x0,0x7,0xf,0x17,0x1f,0x27,0x2f,0x37,0x3f,0x47,0x4f,0x57,0x5f
	,0x67,0x6f,0x77,0x7f,0x87,0x8f,0x97,0x9f,0xa7,0xaf,0xb7,0xbf,0xc7,0xcf,0xd7,0xdf,
	0xe7,0xef,0xf7,0xff,0x107,0x10f,0x117,0x11f,0x127,0x12f,0x137,0x13f,0x147,0x14f,
	0x157,0x15f,0x167,0x16f,0x177,0x17f,0x187,0x18f,0x197,0x19f,0x1a7,0x1af,0x1b7,0x1bf,
	0x1c7,0x1cf,0x1d7,0x1df,0x1e7,0x1ef,0x1f7,0x1ff,0x207,0x20f,0x217,0x21f,0x227,0x22f,
	0x237,0x23f,0x247,0x24f,0x257,0x25f,0x267,0x26f,0x277,0x27f,0x287,0x28f,0x297,0x29f,
	0x2a7,0x2af,0x2b7,0x2bf,0x2c7,0x2cf,0x2d7,0x2df,0x2e7,0x2ef,0x2f7,0x2ff,0x307,0x30f,
	0x317,0x31f,0x327,0x32f,0x337,0x33f,0x347,0x34f,0x357,0x35f,0x367,0x36f,0x377,0x37f,
	0x387,0x38f,0x397,0x39f,0x3a7,0x3af,0x3b7,0x3bf,0x3c7,0x3cf,0x3d7,0x3df,0x3e7,0x3ef,
	0x3f7,0x3f7,0x3ef,0x3e7,0x3df,0x3d7,0x3cf,0x3c7,0x3bf,0x3b7,0x3af,0x3a7,0x39f,0x397,
	0x38f,0x387,0x37f,0x377,0x36f,0x367,0x35f,0x357,0x34f,0x347,0x33f,0x337,0x32f,0x327,
	0x31f,0x317,0x30f,0x307,0x2ff,0x2f7,0x2ef,0x2e7,0x2df,0x2d7,0x2cf,0x2c7,0x2bf,0x2b7,
	0x2af,0x2a7,0x29f,0x297,0x28f,0x287,0x27f,0x277,0x26f,0x267,0x25f,0x257,0x24f,0x247,
	0x23f,0x237,0x22f,0x227,0x21f,0x217,0x20f,0x207,0x1ff,0x1f7,0x1ef,0x1e7,0x1df,0x1d7,
	0x1cf,0x1c7,0x1bf,0x1b7,0x1af,0x1a7,0x19f,0x197,0x18f,0x187,0x17f,0x177,0x16f,0x167,
	0x15f,0x157,0x14f,0x147,0x13f,0x137,0x12f,0x127,0x11f,0x117,0x10f,0x107,0xff,0xf7,0xef,
	0xe7,0xdf,0xd7,0xcf,0xc7,0xbf,0xb7,0xaf,0xa7,0x9f,0x97,0x8f,0x87,0x7f,0x77,0x6f,0x67,0x5f,
0x57,0x4f,0x47,0x3f,0x37,0x2f,0x27,0x1f,0x17,0xf,0x7,0x0};
ucode ye0[2][17]={"      adda      ","     zzuli-509"};
sbit sdo2543=P1^0;sbit sdi2543=P1^1;sbit cs2543=P1^2;sbit clk2543=P1^3;sbit eoc2543=P1^4;
sbit clk5615=P2^0;sbit cs5615=P2^1;sbit din5615=P2^2;
sbit clk522=P2^0;sbit cs522=P2^1;sbit din522=P2^2;
void delaydingshi();
uint getdata(uchar tong);
void outdata();
uchar bohao=1,lvhao=1;
uchar dier[16];
uchar zqth,zqtl; //周期高八位和低八位
uchar bdata ado10l,ado10h,quzhijian=4,adi8_0,adi8_1; //5615的高位和低位，数组取值增加量，2543通道0和1的值
uint ado10,zq16,pinlv=100,jishu=0;  //5615输出值，周期，频率，数组下标
uchar fuzhi=1;      //幅度
sbit ado10h_7=ado10h^7;  //5615高位的第七位
sbit ado10l_7=ado10l^7;  //5615低位的第七位
bit yunxingbiaozhi=0;
uchar dingshijishu=0;    //
void zhengxian();
void sanjiao();
void fangbo();
void main()
{
			PT0=1;
			TMOD=0x11;
			IE=0x8a;
			zq16=(unsigned long)10000000 / 64 / pinlv;
			zqth=(65535-zq16)/256;
			zqtl=(65535-zq16)%256;
	   TH1=zqth;//中断重新装如初值
     TL1=zqtl;
	   TH0=0xdb;//中断重新装如初值
     TL0=0xf0;
			TR1=1;
	//xieru164(0x00);
	chushihua();
	diyihang(ye0[0],0);
	dierhang(ye0[1],0);
	  while(1)
		{
			ajpd();
	}
}
void zhengxian()
{
	yunxingbiaozhi=1;
	while(1)
	{
		adi8_0=getdata(0);
		while(!eoc2543);
		adi8_0/=5;
		if(adi8_0<=15)
		{
			quzhijian=4;
			zq16=15625/adi8_0;
		}
		else if(adi8_0>15&&adi8_0<=30)
		{
			quzhijian=5;
			zq16=23437/adi8_0;
		}
		else if(adi8_0>30)
		{
			quzhijian=8;
			zq16=31250/adi8_0;
		}
		zqth=(65535-zq16)/256;
		zqtl=(65535-zq16)%256;
		adi8_1=getdata(1);
		while(!eoc2543);
		fuzhi=(uint)adi8_1*100/255;
    if(yunxingbiaozhi==0)
		{
			TR0=0;
			anjianexit();
			TR1=1;
			return;
		}
 }
}
void sanjiao()
{
	zhengxian();
	return;
}
void fangbo()
{
	zhengxian();
	return;
}
void T1ms() interrupt 3 using 1
{ 
	TH1=zqth;//中断重新装如初值
  TL1=zqtl;
	if(yunxingbiaozhi==1)
	{
if(bohao==1)
			 {
				// if(sin[jishu]<655)
				ado10=sin[jishu]*fuzhi/100+(0x1ff*(100-fuzhi));
//				 else
//				ado10=sin[jishu]/255*fuzhi/100*255+sin[jishu]%255*fuzhi/100; 
				outdata();
				jishu=(jishu+quzhijian)%256;
				}
			else if(bohao==2)
			{
				ado10=san[jishu]*fuzhi/100+(0x1ff*(100-fuzhi));
				outdata();
				jishu=(jishu+quzhijian)%256;
			}
			else if(bohao==3)
			{
				if(jishu<=128)
					ado10=0+(0x1ff*(100-fuzhi));
				else
					ado10=0x3ff*fuzhi/100+(0x1ff*(100-fuzhi));
				outdata();
					 jishu=(jishu+quzhijian)%256;
			}
	 if(exit==0)
	 {
		 TR0=0;
		 delay(10);
		 if(exit==0)
		 {
			 while(exit==0);
			 yunxingbiaozhi=0;
			 TR0=1;
			 return;
		 }
	 }
		}
			return;
}
void T0ms() interrupt 1 using 2
{
		 TH0=0xdb;//中断重新装如初值
     TL0=0xf0;
	   if(dingshijishu>0)
			 dingshijishu--;
		 else
			 TR0=0;
}

uint getdata(uchar tong)
{
	uchar i,ming;
	uint sj=0;
	tong=tong<<4;
	clk2543=0;
	cs2543=0;
	ming=tong|0x04;
	for(i=0;i<8;i++)
	{
		clk2543=0;
		if(sdo2543)
			sj=sj|0x01;
		sdi2543=(bit)(ming&0x80);
		clk2543=1;
		_nop_();_nop_();_nop_();
		clk2543=0;
		_nop_();_nop_();_nop_();
		ming=ming<<1;
		sj<<=1;
	}
	cs2543=1;
	sj>>=1;
	return sj;
}
void outdata()
{
	uchar i;
	clk5615=0;
	cs5615=0;
	 ado10h=ado10/256;
	 ado10l=ado10%256;
	ado10h<<=6;
	for(i=0;i<2;i++)
	{
		if (ado10h_7)
			din5615=1;
		else
			din5615=0;
		clk5615=1;
		_nop_();
		clk5615=0;
		ado10h<<=1;
	}
	for(i=0;i<8;i++)
	{
		if (ado10l_7)
			din5615=1;
		else
			din5615=0;
		clk5615=1;
		_nop_();
		clk5615=0;
		ado10l<<=1;
	}
	for(i=0;i<2;i++)
	{
		din5615=0;
		clk5615=1;
		_nop_();
		clk5615=0;
		ado10h<<=1;
	}
	cs5615=1;
	clk5615=0;
}
/*
{
	uchar i;
	xiemingling(0x80);  //光标定位到1602第一行第一个位置
	while(i!=16)
	{
		xieshuju(a[i]);  //写入字符
		i++;
	}
	return;
}
*/
/*void xieru164(uchar b)
{
	uchar i;
	for (i=0;i<=7;i++)
	{
		if (b&0x01)
		hc164_data=1;
		else
			hc164_data=0;
		hc164_clk=0;
		_nop_();
		hc164_clk=1;
		b=_cror_(b,1);
	}
}*/
  /*  uchar i=0;
		if (jianpan1==0||jianpan2==0)
		{
			delay(2);
			if (jianpan1==0||jianpan2==0)
			{
				if (jianpan1==0)
				{
					for (i=0;i<=7;i++)
					{
						xieru164(jianpan[i]);
						delay(1);
						if(jianpan1==1)
						{
							xieru164(0);
							while(jianpan1==0);
							jz1=i+1;
							ajb=1;
							return;
						}
					}
					return;
				}
				else if(jianpan2==0)
				{
					for (i=0;i<=7;i++)
					{
						xieru164(jianpan[i]);
						delay(1);
						if(jianpan2==1)
						{
							xieru164(0);
							while(jianpan2==0);
							jz2=i+9;
							ajb=1;
							return;
						}
					}
					return;
				}
				return;
			}
			return;
		}
		return;*/
		/*san[]={0x0,0x1,0x3,0x5,0x7,0x9,0xb,0xd,0xf,0x11,0x13,0x15,0x17,0x19,
0x1b,0x1d,0x1f,0x21,0x23,0x25,0x27,0x29,0x2b,0x2d,0x2f,0x31,0x33,0x35,0x37,0x39,
0x3b,0x3d,0x3f,0x41,0x43,0x45,0x47,0x49,0x4b,0x4d,0x4f,0x51,0x53,0x55,0x57,0x59,
0x5b,0x5d,0x5f,0x61,0x63,0x65,0x67,0x69,0x6b,0x6d,0x6f,0x71,0x73,0x75,0x77,0x79
,0x7b,0x7d,0x7f,0x81,0x83,0x85,0x87,0x89,0x8b,0x8d,0x8f,0x91,0x93,0x95,0x97,0x99
,0x9b,0x9d,0x9f,0xa1,0xa3,0xa5,0xa7,0xa9,0xab,0xad,0xaf,0xb1,0xb3,0xb5,0xb7,0xb9,
0xbb,0xbd,0xbf,0xc1,0xc3,0xc5,0xc7,0xc9,0xcb,0xcd,0xcf,0xd1,0xd3,0xd5,0xd7,0xd9,
0xdb,0xdd,0xdf,0xe1,0xe3,0xe5,0xe7,0xe9,0xeb,0xed,0xef,0xf1,0xf3,0xf5,0xf7,0xf9,
0xfb,0xfd,0xfd,0xfb,0xf9,0xf7,0xf5,0xf3,0xf1,0xef,0xed,0xeb,0xe9,0xe7,0xe5,0xe3,
0xe1,0xdf,0xdd,0xdb,0xd9,0xd7,0xd5,0xd3,0xd1,0xcf,0xcd,0xcb,0xc9,0xc7,0xc5,0xc3,
0xc1,0xbf,0xbd,0xbb,0xb9,0xb7,0xb5,0xb3,0xb1,0xaf,0xad,0xab,0xa9,0xa7,0xa5,0xa3
,0xa1,0x9f,0x9d,0x9b,0x99,0x97,0x95,0x93,0x91,0x8f,0x8d,0x8b,0x89,0x87,0x85,0x83,
0x81,0x7f,0x7d,0x7b,0x79,0x77,0x75,0x73,0x71,0x6f,0x6d,0x6b,0x69,0x67,0x65,0x63,
0x61,0x5f,0x5d,0x5b,0x59,0x57,0x55,0x53,0x51,0x4f,0x4d,0x4b,0x49,0x47,0x45,0x43,
0x41,0x3f,0x3d,0x3b,0x39,0x37,0x35,0x33,0x31,0x2f,0x2d,0x2b,0x29,0x27,0x25,0x23,
0x21,0x1f,0x1d,0x1b,0x19,0x17,0x15,0x13,0x11,0xf,0xd,0xb,0x9,0x7,0x5,0x3,0x1,0x0};
sin[]={0x7f,0x82,0x85,0x88,0x8b,0x8f,0x92,0x95,0x98,0x9b,0x9e,0xa1,
	0xa4,0xa7,0xaa,0xad,0xb0,0xb3,0xb6,0xb8,0xbb,0xbe,0xc1,0xc3,0xc6,0xc8,
	0xcb,0xcd,0xd0,0xd2,0xd5,0xd7,0xd9,0xdb,0xdd,0xe0,0xe2,0xe4,0xe5,0xe7,
	0xe9,0xeb,0xec,0xee,0xef,0xf1,0xf2,0xf4,0xf5,0xf6,0xf7,0xf8,0xf9,0xfa,
	0xfb,0xfb,0xfc,0xfd,0xfd,0xfe,0xfe,0xfe,0xfe,0xfe,0xfe,0xfe,0xfe,0xfe,
	0xfe,0xfe,0xfd,0xfd,0xfc,0xfb,0xfb,0xfa,0xf9,0xf8,0xf7,0xf6,0xf5,0xf4,
	0xf2,0xf1,0xef,0xee,0xec,0xeb,0xe9,0xe7,0xe5,0xe4,0xe2,0xe0,0xdd,0xdb,
	0xd9,0xd7,0xd5,0xd2,0xd0,0xcd,0xcb,0xc8,0xc6,0xc3,0xc1,0xbe,0xbb,0xb8,
	0xb6,0xb3,0xb0,0xad,0xaa,0xa7,0xa4,0xa1,0x9e,0x9b,0x98,0x95,0x92,0x8f,
	0x8c,0x88,0x85,0x82,0x7f,0x7c,0x79,0x76,0x73,0x6f,0x6c,0x69,0x66,0x63,
	0x60,0x5d,0x5a,0x57,0x54,0x51,0x4e,0x4b,0x48,0x46,0x43,0x40,0x3d,0x3b,
	0x38,0x36,0x33,0x31,0x2e,0x2c,0x29,0x27,0x25,0x23,0x21,0x1e,0x1c,0x1a,
	0x19,0x17,0x15,0x13,0x12,0x10,0xf,0xd,0xc,0xa,0x9,0x8,0x7,0x6,0x5,0x4,
	0x3,0x3,0x2,0x1,0x1,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x1,0x1,
	0x2,0x3,0x3,0x4,0x5,0x6,0x7,0x8,0x9,0xa,0xc,0xd,0xf,0x10,0x12,0x13,0x15,
	0x17,0x19,0x1a,0x1c,0x1e,0x21,0x23,0x25,0x27,0x29,0x2c,0x2e,0x31,0x33,0x36,
	0x38,0x3b,0x3d,0x40,0x43,0x46,0x48,0x4b,0x4e,0x51,0x54,0x57,0x5a,0x5d,0x60,
0x63,0x66,0x69,0x6c,0x6f,0x72,0x76,0x79,0x7c};

			if (ajb==1)   //ajb表示adda正在运行
			{
				xsb=1;

					if(pinlv<=150) //100
					{
					zq16=(unsigned long)10000000 / 64 / pinlv;
					zqth=(65535-zq16)/256;
					zqtl=(65535-zq16)%256;
					}
					else
					{
					zqth=0xfb;  //0xf9;
					zqtl=0xef;  //0x18;
					quzhijian=pinlv*0.027;  //0.04
					}
			//adi12=getdata(0);
			//ado10=adi12*0.2498;
			//outdata();
			}
			if(xsb==1)
			{
					delay(1);
					dier[0]=pinlv/100+0x30;
					dier[1]=pinlv%100/10+0x30;
					dier[2]='.';
					dier[3]=pinlv%10+0x30;
					dier[4]='h';
					dier[5]='z';
					dier[6]=' ';
					dier[7]='+';
					dier[8]='/';
					dier[9]='-';
					dier[10]=0;
					dierhang(&dier[0],0);
				switch(dangwei)
        {
        	case 1:	dierhang("0.1hz",11);
				break;
        	case 10:dierhang("  1hz",11);
				break;
       	 	case 100:dierhang("10hz",12);
				break;
				}
					switch(bohao)
        {
        	case 1:	diyihang(boxing[0],0);
				break;
        	case 2:diyihang(boxing[1],0);
				break;
       	 	case 3:diyihang(boxing[2],0);
				break;
				}
				if(ajb==0)
					diyihang("j",15);
				else
				{
						diyihang("n",15);
				}
				xsb=0;
			}*/